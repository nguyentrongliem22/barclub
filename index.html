<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Club Ultimate Management v3.0</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Dark Theme */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #f59e0b;
        }
        body { background-color: var(--bg-primary); color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Mobile Optimizations */
        .touch-action-none { touch-action: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS WRAPPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- FORMATTERS ---
        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const formatDate = (date) => new Date(date).toLocaleString('vi-VN');

        // --- AUTH DATA ---
        const USERS = [
            { username: 'admin', password: '123', role: 'manager', name: 'Qu·∫£n L√Ω C·∫•p Cao' },
            { username: 'staff1', password: '123', role: 'staff', name: 'Nh√¢n vi√™n 1' },
            { username: 'staff2', password: '123', role: 'staff', name: 'Nh√¢n vi√™n 2' },
        ];

        // --- INITIAL DATA ---
        const SEED_INVENTORY = [
            { id: 'INV1', name: 'Chivas 18 (Chai)', stock: 20, unit: 'Chai', minStock: 5 },
            { id: 'INV2', name: 'Whisky Base (L√≠t)', stock: 5000, unit: 'ml', minStock: 1000 },
            { id: 'INV3', name: 'Heineken (Th√πng)', stock: 50, unit: 'Th√πng', minStock: 10 },
            { id: 'INV4', name: 'Tr√°i c√¢y (Kg)', stock: 20, unit: 'Kg', minStock: 5 },
            { id: 'INV5', name: 'Syrup Cam', stock: 2000, unit: 'ml', minStock: 500 },
        ];

        const SEED_MENU = [
            { id: 1, name: 'Chivas 18 Bottle', category: 'R∆∞·ª£u M·∫°nh', price: 2500000, image: 'ü•É', recipe: [{ invId: 'INV1', amount: 1 }] },
            { id: 2, name: 'Old Fashioned', category: 'Cocktail', price: 250000, image: 'üç∏', recipe: [{ invId: 'INV2', amount: 60 }, { invId: 'INV5', amount: 10 }] },
            { id: 3, name: 'Heineken Chai', category: 'Bia', price: 80000, image: 'üç∫', recipe: [] }, 
            { id: 4, name: 'Dƒ©a Tr√°i C√¢y L·ªõn', category: 'ƒê·ªì ƒÇn', price: 500000, image: 'üçâ', recipe: [{ invId: 'INV4', amount: 2 }] },
        ];

        const SEED_TABLES = Array.from({ length: 12 }, (_, i) => ({
            id: `TB${i+1}`, name: `B√†n ${i+1}`, zone: i < 4 ? 'VIP' : 'Normal', status: 'empty', orders: [], owner: null // owner: username c·ªßa staff m·ªü b√†n
        }));

        // --- COMPONENTS ---

        // 1. LOGIN SCREEN
        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                const user = USERS.find(u => u.username === username && u.password === password);
                if (user) {
                    onLogin(user);
                } else {
                    setError('T√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 p-4">
                    <div className="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-gradient-to-br from-amber-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center text-4xl mb-4">üç∑</div>
                            <h1 className="text-2xl font-bold text-white">BAR ULTIMATE</h1>
                            <p className="text-slate-400">H·ªá th·ªëng qu·∫£n l√Ω chuy√™n nghi·ªáp</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">T√†i kho·∫£n</label>
                                <input type="text" value={username} onChange={e=>setUsername(e.target.value)} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 outline-none" placeholder="admin / staff1 / staff2" />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">M·∫≠t kh·∫©u</label>
                                <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 outline-none" placeholder="123" />
                            </div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <button type="submit" className="w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded-lg transition-colors">ƒêƒÉng Nh·∫≠p</button>
                        </form>
                        <div className="mt-6 text-center text-xs text-slate-500">
                            <p>Admin: admin / 123</p>
                            <p>Staff: staff1 / 123 | staff2 / 123</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                    <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-xl shrink-0">
                        <h3 className="font-bold text-lg text-white">{title}</h3>
                        <button onClick={onClose} className="p-1 hover:bg-red-500/20 hover:text-red-500 rounded"><Icon name="x"/></button>
                    </div>
                    <div className="p-4 overflow-y-auto flex-1">{children}</div>
                </div>
            </div>
        );

        // 2. MANAGER: Void Request Handler
        const RequestManager = ({ requests, onApprove, onReject }) => (
            <div className="p-4 md:p-8">
                <h2 className="text-xl font-bold text-amber-500 mb-6 flex items-center gap-2">
                    <Icon name="bell-ring" /> Y√™u C·∫ßu C·∫ßn Duy·ªát ({requests.length})
                </h2>
                {requests.length === 0 ? (
                    <div className="text-slate-500 italic">Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù.</div>
                ) : (
                    <div className="grid gap-4">
                        {requests.map(req => (
                            <div key={req.id} className="bg-slate-800 p-4 rounded-xl border border-slate-600 flex justify-between items-center shadow-lg">
                                <div>
                                    <div className="font-bold text-lg text-white">{req.tableName}</div>
                                    <div className="text-red-400 font-medium">Y√™u c·∫ßu h·ªßy: {req.itemName} <span className="text-xs bg-slate-700 px-1 rounded text-white">x{req.qty}</span></div>
                                    <div className="text-slate-500 text-xs mt-1">L√Ω do: {req.reason || 'Kh√°ch ƒë·ªïi √Ω/Nh·∫ßm l·∫´n'}</div>
                                    <div className="text-slate-600 text-xs">{formatDate(req.time)} - B·ªüi: {req.staff}</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => onReject(req.id)} className="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold">T·ª´ ch·ªëi</button>
                                    <button onClick={() => onApprove(req.id)} className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold">Duy·ªát H·ªßy</button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        // 3. POS SYSTEM (Updated with Table Ownership)
        const POSSystem = ({ tables, menu, currentUser, onUpdateTable, onCheckout, onVoidRequest }) => {
            const [activeTable, setActiveTable] = useState(null);
            const [billingTable, setBillingTable] = useState(null);
            const [filterZone, setFilterZone] = useState('All');
            const [voidItem, setVoidItem] = useState(null);

            const calculateTotal = (orders) => orders.reduce((sum, item) => sum + (item.price * item.qty), 0);

            // X·ª≠ l√Ω khi nh·∫•n v√†o b√†n
            const handleTableClick = (table) => {
                // Logic Quy·ªÅn h·∫°n:
                // 1. Admin (manager) ƒë∆∞·ª£c m·ªü m·ªçi b√†n.
                // 2. B√†n tr·ªëng (empty) -> Ai c≈©ng ƒë∆∞·ª£c m·ªü.
                // 3. B√†n ƒëang c√≥ kh√°ch (occupied) -> Ch·ªâ ch·ªß b√†n (owner) ho·∫∑c Manager m·ªõi ƒë∆∞·ª£c m·ªü ƒë·ªÉ order ti·∫øp.
                
                const isManager = currentUser.role === 'manager';
                const isEmpty = table.status === 'empty';
                const isOwner = table.owner === currentUser.username;

                if (isManager || isEmpty || isOwner) {
                    setActiveTable(table);
                } else {
                    alert(`‚õî B√†n n√†y ƒëang ƒë∆∞·ª£c ph·ª•c v·ª• b·ªüi: ${table.owner || 'Unknown'}\nB·∫°n ch·ªâ c√≥ quy·ªÅn xem, kh√¥ng ƒë∆∞·ª£c ch·ªânh s·ª≠a.`);
                }
            };

            const addToOrder = (item) => {
                const currentOrders = activeTable.orders ? [...activeTable.orders] : [];
                const existingIndex = currentOrders.findIndex(o => o.id === item.id);
                
                if (existingIndex > -1) {
                    currentOrders[existingIndex] = { ...currentOrders[existingIndex], qty: currentOrders[existingIndex].qty + 1 };
                } else {
                    currentOrders.push({ ...item, qty: 1, committedQty: 0 });
                }
                setActiveTable({ ...activeTable, orders: currentOrders });
            };

            const handleMinusClick = (item) => {
                if (item.qty > (item.committedQty || 0)) {
                     const currentOrders = [...activeTable.orders];
                     const idx = currentOrders.findIndex(o => o.id === item.id);
                     if (currentOrders[idx].qty > 1) {
                         currentOrders[idx].qty -= 1;
                     } else {
                         currentOrders.splice(idx, 1);
                     }
                     setActiveTable({ ...activeTable, orders: currentOrders });
                } else {
                    setVoidItem(item);
                }
            };

            const confirmVoidRequest = () => {
                onVoidRequest(activeTable.id, activeTable.name, voidItem, 1);
                setVoidItem(null);
                alert("ƒê√£ g·ª≠i y√™u c·∫ßu h·ªßy m√≥n l√™n Qu·∫£n l√Ω!");
            };

            const saveOrder = () => {
                const committedOrders = activeTable.orders.map(o => ({ ...o, committedQty: o.qty }));
                
                // Khi l∆∞u order, n·∫øu b√†n tr∆∞·ªõc ƒë√≥ tr·ªëng -> g√°n owner l√† user hi·ªán t·∫°i
                const newOwner = activeTable.status === 'empty' ? currentUser.username : activeTable.owner;

                onUpdateTable(activeTable.id, { 
                    orders: committedOrders, 
                    status: committedOrders.length > 0 ? 'occupied' : 'empty',
                    owner: committedOrders.length > 0 ? newOwner : null
                });
                setActiveTable(null);
            };

            const handleCheckoutClick = () => setBillingTable(activeTable);
            const confirmPayment = () => { onCheckout(billingTable); setBillingTable(null); setActiveTable(null); };

            const zones = ['All', ...new Set(tables.map(t => t.zone))];

            const renderVoidModal = () => (
                <Modal title="Y√™u c·∫ßu h·ªßy m√≥n" onClose={() => setVoidItem(null)}>
                    <div className="text-center p-4">
                        <p className="text-slate-300 mb-2">M√≥n n√†y ƒë√£ ƒë∆∞·ª£c g·ª≠i Order.</p>
                        <h3 className="text-xl font-bold text-white mb-4">{voidItem?.name}</h3>
                        <p className="text-sm text-slate-400 mb-6">B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a tr·ª±c ti·∫øp. Vui l√≤ng g·ª≠i y√™u c·∫ßu duy·ªát.</p>
                        <button onClick={confirmVoidRequest} className="w-full py-3 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg">G·ª≠i y√™u c·∫ßu ho√†n tr·∫£ (x1)</button>
                    </div>
                </Modal>
            );

            // Render POS Interface
            if (activeTable && !billingTable) return (
                <div className="fixed inset-0 bg-slate-900 z-40 flex flex-col md:flex-row animate-fade-in">
                    {voidItem && renderVoidModal()}
                    
                    {/* Header Mobile */}
                    <div className="md:hidden h-14 border-b border-slate-700 flex items-center justify-between px-4 bg-slate-800">
                        <button onClick={() => setActiveTable(null)}><Icon name="arrow-left"/></button>
                        <span className="font-bold">{activeTable.name}</span>
                        <span className="text-amber-500">{formatMoney(calculateTotal(activeTable.orders))}</span>
                    </div>

                    {/* Left: Menu Grid */}
                    <div className="flex-1 overflow-y-auto p-4 md:border-r border-slate-700 bg-slate-900">
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            {menu.map(item => (
                                <button key={item.id} onClick={() => addToOrder(item)} className="bg-slate-800 p-3 rounded-xl border border-slate-700 active:scale-95 transition-transform text-left hover:border-amber-500">
                                    <div className="text-3xl mb-2">{item.image}</div>
                                    <div className="font-bold text-sm text-slate-200 truncate">{item.name}</div>
                                    <div className="text-amber-500 text-xs font-mono">{formatMoney(item.price)}</div>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Right: Order Bill */}
                    <div className="h-[45vh] md:h-full md:w-96 bg-slate-800 flex flex-col border-t md:border-t-0 border-slate-700 shadow-2xl">
                        <div className="hidden md:flex p-4 border-b border-slate-700 justify-between items-center">
                            <h2 className="font-bold text-xl">{activeTable.name}</h2>
                            <button onClick={() => setActiveTable(null)}><Icon name="x" className="text-slate-400 hover:text-white"/></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {activeTable.orders.length === 0 ? 
                                <div className="text-center text-slate-500 mt-10">Ch∆∞a c√≥ m√≥n n√†o</div> :
                                activeTable.orders.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center bg-slate-700/30 p-2 rounded relative group">
                                        <div className="flex-1">
                                            <div className="text-sm font-bold text-white">
                                                {item.name}
                                                {(item.committedQty > 0) && <span className="ml-2 text-[10px] bg-green-900 text-green-300 px-1 rounded">ƒê√£ g·ª≠i: {item.committedQty}</span>}
                                            </div>
                                            <div className="text-xs text-amber-500">{formatMoney(item.price)}</div>
                                        </div>
                                        <div className="flex items-center gap-3 bg-slate-900 rounded p-1">
                                            <button onClick={() => handleMinusClick(item)} className="p-1 text-slate-400 hover:text-red-400">
                                                {item.qty <= (item.committedQty||0) ? <Icon name="shield-alert" size={16} className="text-red-500"/> : <Icon name="minus" size={16}/>}
                                            </button>
                                            <span className="font-mono font-bold text-white w-4 text-center">{item.qty}</span>
                                            <button onClick={() => addToOrder(item)} className="p-1 text-slate-400 hover:text-green-400"><Icon name="plus" size={16}/></button>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>

                        <div className="p-4 bg-slate-900 border-t border-slate-700 space-y-3">
                            <div className="flex justify-between text-white text-lg font-bold">
                                <span>T·ªïng c·ªông</span>
                                <span className="text-amber-500">{formatMoney(calculateTotal(activeTable.orders) * 1.08)}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={saveOrder} className="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                    <Icon name="send" size={16}/> G·ª≠i B·∫øp
                                </button>
                                <button onClick={handleCheckoutClick} className="bg-amber-600 hover:bg-amber-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                    <Icon name="credit-card" size={16}/> Thanh To√°n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
            
            // Billing Modal
            const renderBillingModal = () => {
                if (!billingTable) return null;
                const subTotal = calculateTotal(billingTable.orders);
                return (
                    <Modal title="X√°c nh·∫≠n thanh to√°n" onClose={() => setBillingTable(null)}>
                         <div className="bg-white text-slate-900 p-4 rounded font-mono text-sm shadow-inner mb-4">
                            <div className="text-center pb-4 border-b border-dashed border-slate-300 mb-4">
                                <h2 className="text-xl font-bold">BAR CLUB ULTIMATE</h2>
                                <p className="text-xs text-slate-500">{new Date().toLocaleString()}</p>
                                <p className="text-xs text-slate-500">NV: {currentUser.name}</p>
                            </div>
                            <div className="mb-2 font-bold">{billingTable.name}</div>
                            <div className="space-y-2 mb-4">
                                {billingTable.orders.map((item, idx) => (
                                    <div key={idx} className="flex justify-between">
                                        <span>{item.name} <span className="text-xs text-slate-500">x{item.qty}</span></span>
                                        <span>{formatMoney(item.price * item.qty)}</span>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-dashed border-slate-300 pt-2 space-y-1">
                                <div className="flex justify-between text-lg font-bold mt-2"><span>T·ªîNG C·ªòNG (VAT 8%)</span><span>{formatMoney(subTotal * 1.08)}</span></div>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => setBillingTable(null)} className="flex-1 py-3 bg-slate-700 rounded-lg text-white font-bold">H·ªßy</button>
                            <button onClick={confirmPayment} className="flex-1 py-3 bg-green-600 rounded-lg text-white font-bold">In & Thanh To√°n</button>
                        </div>
                    </Modal>
                )
            };

            return (
                <div className="h-full flex flex-col">
                    {billingTable && renderBillingModal()}
                    <div className="flex gap-2 p-4 overflow-x-auto bg-slate-900/50 backdrop-blur border-b border-slate-800 shrink-0">
                        {zones.map(z => (
                            <button key={z} onClick={() => setFilterZone(z)} 
                                className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${filterZone === z ? 'bg-amber-500 text-black' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>
                                {z}
                            </button>
                        ))}
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {tables.filter(t => filterZone === 'All' || t.zone === filterZone).map(table => {
                            // Check ownership for styling
                            const isMyTable = table.owner === currentUser.username;
                            const isOccupied = table.status === 'occupied';

                            return (
                                <div key={table.id} onClick={() => handleTableClick(table)} 
                                    className={`relative aspect-square rounded-2xl p-4 flex flex-col justify-between cursor-pointer border-2 shadow-lg transition-all active:scale-95
                                    ${isOccupied 
                                        ? (isMyTable || currentUser.role === 'manager' ? 'bg-slate-800 border-green-500 shadow-green-500/10' : 'bg-slate-800 border-red-900 opacity-70') 
                                        : 'bg-slate-800 border-slate-700 hover:border-slate-500'}`}>
                                    <div className="flex justify-between items-center">
                                        <span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase ${table.zone === 'VIP' ? 'bg-amber-500 text-black' : 'bg-slate-700 text-slate-400'}`}>{table.zone}</span>
                                        {isOccupied && <Icon name={isMyTable ? "user-check" : "lock"} size={14} className={isMyTable ? "text-green-500" : "text-red-500"}/>}
                                    </div>
                                    <div className="text-center">
                                        <h3 className="text-xl font-black text-white">{table.name}</h3>
                                        {isOccupied ? 
                                            <div className="mt-1">
                                                <p className="text-green-400 text-xs font-mono">{formatMoney(calculateTotal(table.orders))}</p>
                                                <p className="text-[10px] text-slate-500 mt-1 truncate">{table.owner}</p>
                                            </div> : 
                                            <p className="text-slate-600 text-xs mt-1">Tr·ªëng</p>
                                        }
                                    </div>
                                    <div className={`w-full h-1.5 rounded-full ${isOccupied ? 'bg-green-500' : 'bg-slate-700'}`}></div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const MenuManager = ({ menu, inventory, onUpdateMenu }) => {
            const [editingItem, setEditingItem] = useState(null);
            const handleSave = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const newItem = {
                    id: editingItem?.id || Date.now(),
                    name: formData.get('name'),
                    category: formData.get('category'),
                    price: Number(formData.get('price')),
                    image: formData.get('image'),
                    recipe: [] 
                };
                onUpdateMenu(newItem, editingItem ? 'update' : 'add');
                setEditingItem(null);
            };
            return (
                <div className="p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-amber-500">Qu·∫£n l√Ω Th·ª±c ƒê∆°n</h2>
                        <button onClick={() => setEditingItem({})} className="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded flex items-center gap-2"><Icon name="plus-circle"/> Th√™m M√≥n</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {menu.map(item => (
                            <div key={item.id} className="bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between items-start">
                                <div className="flex gap-3">
                                    <div className="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center text-2xl">{item.image}</div>
                                    <div><h4 className="font-bold text-white">{item.name}</h4><p className="text-amber-500 font-mono">{formatMoney(item.price)}</p></div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setEditingItem(item)} className="p-2 bg-slate-700 rounded hover:text-amber-400"><Icon name="edit-2" size={16}/></button>
                                    <button onClick={() => onUpdateMenu(item, 'delete')} className="p-2 bg-slate-700 rounded hover:text-red-400"><Icon name="trash" size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                    {editingItem && (
                        <Modal title={editingItem.id ? "S·ª≠a M√≥n" : "Th√™m M√≥n"} onClose={() => setEditingItem(null)}>
                            <form onSubmit={handleSave} className="space-y-4">
                                <div><label className="block text-sm text-slate-400">T√™n m√≥n</label><input name="name" defaultValue={editingItem.name} required className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"/></div>
                                <div><label className="block text-sm text-slate-400">Gi√° b√°n</label><input type="number" name="price" defaultValue={editingItem.price} required className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"/></div>
                                <div><label className="block text-sm text-slate-400">Icon</label><input name="image" defaultValue={editingItem.image || "üç∏"} className="w-full bg-slate-800 border border-slate-600 rounded p-2 text-white"/></div>
                                <button type="submit" className="w-full bg-amber-500 text-black font-bold py-3 rounded">L∆∞u</button>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null); // Auth State
            const [view, setView] = useState('dashboard');
            
            const [menu, setMenu] = useState(SEED_MENU);
            const [inventory, setInventory] = useState(SEED_INVENTORY);
            const [tables, setTables] = useState(SEED_TABLES);
            const [transactions, setTransactions] = useState([]);
            const [requests, setRequests] = useState([]);

            // CALCULATE STAFF RANKING
            const getStaffStats = (username) => {
                const mySales = transactions.filter(t => t.staff === username).reduce((sum, t) => sum + t.total, 0);
                
                // Calculate Rank
                // Get all sales by staff
                const staffSales = {};
                transactions.forEach(t => {
                    staffSales[t.staff] = (staffSales[t.staff] || 0) + t.total;
                });
                // Sort
                const sortedStaff = Object.keys(staffSales).sort((a,b) => staffSales[b] - staffSales[a]);
                const rank = sortedStaff.indexOf(username) + 1;

                return { mySales, rank: rank > 0 ? rank : '-' };
            };

            const handleLogin = (user) => {
                setCurrentUser(user);
                // Redirect logic based on role
                if (user.role === 'staff') setView('pos');
                else setView('dashboard');
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setView('dashboard');
            };

            const handleUpdateTable = (tableId, newData) => {
                setTables(prev => prev.map(t => t.id === tableId ? { ...t, ...newData } : t));
            };

            const handleCheckout = (table) => {
                const total = table.orders.reduce((s, i) => s + (i.price * i.qty), 0) * 1.08;
                // Save transaction with staff info
                setTransactions([{ 
                    id: Date.now(), 
                    total, 
                    time: new Date().toISOString(), 
                    table: table.name,
                    staff: currentUser.username // Save staff username
                }, ...transactions]);

                handleUpdateTable(table.id, { orders: [], status: 'empty', owner: null });
            };

            const handleVoidRequest = (tableId, tableName, item, qty) => {
                const newReq = {
                    id: Date.now(),
                    tableId, tableName,
                    itemId: item.id, itemName: item.name,
                    qty,
                    time: new Date().toISOString(),
                    staff: currentUser.username,
                    status: 'pending'
                };
                setRequests([newReq, ...requests]);
            };

            const handleApproveVoid = (reqId) => {
                const req = requests.find(r => r.id === reqId);
                if (!req) return;
                setTables(prev => prev.map(t => {
                    if (t.id === req.tableId) {
                        const newOrders = [...t.orders];
                        const idx = newOrders.findIndex(o => o.id === req.itemId);
                        if (idx > -1) {
                            if (newOrders[idx].qty > req.qty) {
                                newOrders[idx].qty -= req.qty;
                                newOrders[idx].committedQty -= req.qty;
                            } else {
                                newOrders.splice(idx, 1);
                            }
                        }
                        return { ...t, orders: newOrders, status: newOrders.length > 0 ? 'occupied' : 'empty' };
                    }
                    return t;
                }));
                setRequests(requests.filter(r => r.id !== reqId));
                alert("ƒê√£ duy·ªát h·ªßy m√≥n.");
            };

            const handleRejectVoid = (reqId) => {
                setRequests(requests.filter(r => r.id !== reqId));
                alert("ƒê√£ t·ª´ ch·ªëi h·ªßy m√≥n.");
            };

            const handleUpdateMenu = (item, action) => {
                if (action === 'add') setMenu([...menu, item]);
                if (action === 'update') setMenu(menu.map(m => m.id === item.id ? item : m));
                if (action === 'delete') {
                    if (confirm("X√≥a m√≥n n√†y?")) setMenu(menu.filter(m => m.id !== item.id));
                }
            };

            // IF NOT LOGGED IN
            if (!currentUser) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            // MENU CONFIG
            const menuItems = currentUser.role === 'manager' 
                ? [
                    { id: 'dashboard', icon: 'bar-chart-2', label: 'T·ªïng Quan' },
                    { id: 'requests', icon: 'bell-ring', label: `Y√™u C·∫ßu (${requests.length})`, alert: requests.length > 0 },
                    { id: 'pos', icon: 'grid', label: 'Thu Ng√¢n & B√†n' },
                    { id: 'menu', icon: 'book-open', label: 'Th·ª±c ƒê∆°n' },
                    { id: 'inventory', icon: 'package', label: 'Kho H√†ng' },
                ] 
                : [
                    { id: 'pos', icon: 'grid', label: 'S∆° ƒë·ªì b√†n / G·ªçi m√≥n' }
                ];

            // STAFF RANKING DISPLAY
            const StaffStats = () => {
                if (currentUser.role === 'manager') return null;
                const { mySales, rank } = getStaffStats(currentUser.username);
                return (
                    <div className="mx-4 mt-4 mb-2 p-3 bg-slate-800 rounded-xl border border-slate-700">
                        <div className="flex items-center gap-3 mb-2">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center font-bold text-white text-sm">
                                #{rank}
                            </div>
                            <div>
                                <p className="text-xs text-slate-400">X·∫øp h·∫°ng</p>
                                <p className="text-sm font-bold text-white">Top {rank}</p>
                            </div>
                        </div>
                        <div className="border-t border-slate-700 pt-2">
                             <p className="text-xs text-slate-400">Doanh s·ªë c√° nh√¢n</p>
                             <p className="text-amber-500 font-mono font-bold">{formatMoney(mySales)}</p>
                        </div>
                    </div>
                )
            };

            const Sidebar = () => (
                <div className="hidden md:flex w-64 flex-col bg-slate-900 border-r border-slate-800 h-screen fixed left-0 top-0 z-20">
                    <div className="p-6 border-b border-slate-800">
                        <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-500 to-purple-600">BAR PRO</h1>
                        <p className="text-xs text-slate-500 mt-1">Xin ch√†o, <span className="text-white font-bold">{currentUser.name}</span></p>
                    </div>
                    
                    <StaffStats />

                    <nav className="flex-1 p-4 space-y-2">
                        {menuItems.map(item => (
                            <button key={item.id} onClick={() => setView(item.id)} 
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all relative ${view === item.id ? 'bg-amber-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>
                                <Icon name={item.icon} size={18}/> 
                                <span>{item.label}</span>
                                {item.alert && <span className="absolute right-4 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
                            </button>
                        ))}
                    </nav>
                    <div className="p-4 border-t border-slate-800">
                        <button onClick={handleLogout} className="w-full py-2 bg-slate-800 rounded text-xs text-red-400 hover:text-red-300 transition-colors flex items-center justify-center gap-2">
                            <Icon name="log-out" size={14} /> ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            );

            const MainContent = () => {
                switch(view) {
                    case 'pos': return <POSSystem tables={tables} menu={menu} currentUser={currentUser} onUpdateTable={handleUpdateTable} onCheckout={handleCheckout} onVoidRequest={handleVoidRequest} />;
                    case 'requests': return <RequestManager requests={requests} onApprove={handleApproveVoid} onReject={handleRejectVoid} />;
                    case 'menu': return <MenuManager menu={menu} inventory={inventory} onUpdateMenu={handleUpdateMenu} />;
                    case 'inventory': return <div className="p-8"><h2 className="text-xl font-bold mb-4">Kho H√†ng</h2><p className="text-slate-500">Danh s√°ch kho...</p></div>;
                    case 'dashboard': 
                        if (currentUser.role === 'staff') return <div className="p-10 text-center">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.</div>;
                        return (
                             <div className="p-8">
                                <h2 className="text-2xl font-bold mb-4">Dashboard Qu·∫£n L√Ω</h2>
                                <div className="bg-slate-800 p-6 rounded-xl border border-slate-700">
                                    <h3 className="text-lg font-bold mb-2">Th·ªëng k√™ nhanh</h3>
                                    <p>Doanh thu: {formatMoney(transactions.reduce((s,t)=>s+t.total,0))}</p>
                                    <p>ƒê∆°n h√†ng: {transactions.length}</p>
                                </div>
                             </div>
                        );
                    default: return <div className="p-10 text-slate-500">Ch·ª©c nƒÉng ƒëang c·∫≠p nh·∫≠t...</div>;
                }
            };

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200">
                    <Sidebar />
                    
                    {/* Mobile Menu */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800 z-50 flex justify-around p-2 safe-bottom">
                         {menuItems.map(item => (
                            <button key={item.id} onClick={() => setView(item.id)} className={`p-2 rounded-lg relative ${view === item.id ? 'text-amber-500 bg-slate-800' : 'text-slate-400'}`}>
                                <Icon name={item.icon} />
                                {item.alert && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>}
                            </button>
                        ))}
                         <button onClick={handleLogout} className="p-2 rounded-lg text-red-400"><Icon name="log-out" /></button>
                    </div>

                    <div className="md:pl-64 h-screen flex flex-col overflow-hidden pb-16 md:pb-0">
                        <div className="flex-1 overflow-auto bg-slate-950 relative">
                            <MainContent />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
