<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan Club Management System</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base Dark Theme */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #f59e0b;
        }
        body { background-color: var(--bg-primary); color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Mobile Optimizations */
        .touch-action-none { touch-action: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS WRAPPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.setAttribute('width', size);
                    i.setAttribute('height', size);
                    if (className) i.setAttribute('class', className);
                    iconRef.current.innerHTML = '';
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({ root: iconRef.current });
                }
            }, [name, size, className]);
            return <span ref={iconRef} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        // --- FORMATTERS ---
        const formatMoney = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const formatDate = (date) => new Date(date).toLocaleString('vi-VN');

        // --- AUTH DATA ---
        const USERS = [
            { username: 'admin', role: 'manager', name: 'Qu·∫£n L√Ω C·∫•p Cao' },
            { username: 'staff1', role: 'staff', name: 'Nh√¢n vi√™n 1' },
            { username: 'staff2', role: 'staff', name: 'Nh√¢n vi√™n 2' },
            { username: 'guest', role: 'guest', name: 'Kh√°ch H√†ng' },
        ];

        // --- INITIAL DATA ---
        const SEED_MENU = [
            { id: 1, name: 'Chivas 18 Bottle', category: 'R∆∞·ª£u M·∫°nh', price: 2500000, image: 'ü•É' },
            { id: 2, name: 'Old Fashioned', category: 'Cocktail', price: 250000, image: 'üç∏' },
            { id: 3, name: 'Heineken Chai', category: 'Bia', price: 80000, image: 'üç∫' }, 
            { id: 4, name: 'Dƒ©a Tr√°i C√¢y L·ªõn', category: 'ƒê·ªì ƒÇn', price: 500000, image: 'üçâ' },
            { id: 5, name: 'Combo Titan VIP', category: 'Combo', price: 5000000, image: 'üëë' },
        ];

        const SEED_TABLES = Array.from({ length: 12 }, (_, i) => ({
            id: `TB${i+1}`, name: `B√†n ${i+1}`, zone: i < 4 ? 'VIP' : 'Normal', status: 'empty', orders: [], owner: null, booking: null
        }));

        const SEED_EXPENSES = [
            { id: 1, name: 'Nh·∫≠p r∆∞·ª£u ƒë·ª£t 1', amount: 15000000, date: '2023-10-20', type: 'Nh·∫≠p h√†ng' },
            { id: 2, name: 'Ti·ªÅn ƒëi·ªán th√°ng 10', amount: 5000000, date: '2023-10-25', type: 'ƒêi·ªán n∆∞·ªõc' },
            { id: 3, name: 'Marketing FB Ads', amount: 2000000, date: '2023-10-26', type: 'Marketing' },
        ];

        const SEED_FEEDBACKS = [
            { id: 1, customer: 'Guest 01', rating: 5, comment: 'D·ªãch v·ª• tuy·ªát v·ªùi, nh√¢n vi√™n nhanh nh·∫πn.', date: '2023-10-26' },
            { id: 2, customer: 'Guest 02', rating: 4, comment: 'Nh·∫°c h∆°i to nh∆∞ng ƒë·ªì u·ªëng ngon.', date: '2023-10-26' },
        ];

        // --- COMPONENTS ---

        const Modal = ({ title, onClose, children, maxWidth = "max-w-lg" }) => (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className={`bg-slate-900 border border-slate-700 w-full ${maxWidth} rounded-xl shadow-2xl flex flex-col max-h-[90vh]`}>
                    <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-xl shrink-0">
                        <h3 className="font-bold text-lg text-white">{title}</h3>
                        <button onClick={onClose} className="p-1 hover:bg-red-500/20 hover:text-red-500 rounded"><Icon name="x"/></button>
                    </div>
                    <div className="p-4 overflow-y-auto flex-1">{children}</div>
                </div>
            </div>
        );

        // LOGIN SCREEN
        const LoginScreen = ({ onLogin }) => {
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 p-4">
                    <div className="bg-slate-900 border border-slate-700 p-8 rounded-2xl w-full max-w-5xl shadow-2xl animate-fade-in flex flex-col md:flex-row gap-10">
                        <div className="flex-1">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-gradient-to-br from-amber-500 to-purple-600 rounded-2xl mx-auto flex items-center justify-center text-4xl mb-4">üç∑</div>
                                <h1 className="text-3xl font-black text-white tracking-wider">TITAN CLUB</h1>
                                <p className="text-slate-400 mt-2">H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n h√†nh Nightlife</p>
                            </div>
                            <div className="space-y-3">
                                <p className="text-center text-slate-400 mb-4 text-sm font-medium">‚ñº Ch·ªçn t√†i kho·∫£n truy c·∫≠p nhanh ‚ñº</p>
                                <div className="grid grid-cols-1 gap-3">
                                    {USERS.map(user => (
                                        <button key={user.username} onClick={() => onLogin(user)} className={`w-full p-4 rounded-xl border flex items-center gap-4 transition-all hover:scale-[1.02] active:scale-95 group ${user.role === 'manager' ? 'bg-purple-900/20 border-purple-500/30' : user.role === 'staff' ? 'bg-amber-900/20 border-amber-500/30' : 'bg-blue-900/20 border-blue-500/30'}`}>
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-lg ${user.role === 'manager' ? 'bg-purple-600 text-white' : user.role === 'staff' ? 'bg-amber-600 text-black' : 'bg-blue-600 text-white'}`}>{user.name.charAt(0)}</div>
                                            <div className="text-left flex-1">
                                                <h3 className="font-bold text-white text-lg">{user.name}</h3>
                                                <p className="text-xs text-slate-400 uppercase tracking-wide font-semibold">{user.role}</p>
                                            </div>
                                            <Icon name="arrow-right" size={20} className="text-slate-300 opacity-50 group-hover:opacity-100"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 border-l border-slate-800 pl-0 md:pl-10 pt-6 md:pt-0 border-t md:border-t-0">
                            <h3 className="text-xl font-bold text-amber-500 mb-6 flex items-center gap-2"><Icon name="info" size={24}/> QUY TR√åNH THANH TO√ÅN</h3>
                            <div className="space-y-4 text-sm text-slate-300">
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                                    <strong className="text-white block mb-1">1. Y√™u C·∫ßu (Staff)</strong>
                                    <p className="text-xs text-slate-400">Nh√¢n vi√™n ph·ª•c v·ª• b·∫•m "Y√™u c·∫ßu thanh to√°n". B√†n chuy·ªÉn tr·∫°ng th√°i ch·ªù (T√≠m).</p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                                    <strong className="text-white block mb-1">2. Xu·∫•t H√≥a ƒê∆°n (Admin)</strong>
                                    <p className="text-xs text-slate-400">Admin nh·∫≠n th√¥ng b√°o -> Ki·ªÉm tra order -> B·∫•m "Xu·∫•t h√≥a ƒë∆°n & QR".</p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                                    <strong className="text-white block mb-1">3. Thu Ti·ªÅn (Admin)</strong>
                                    <p className="text-xs text-slate-400">Kh√°ch qu√©t QR -> Admin x√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn -> H·ªá th·ªëng ghi nh·∫≠n doanh thu v√† ƒë√≥ng b√†n.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // GUEST DASHBOARD (Simplified for brevity)
        const GuestDashboard = ({ tables, menu, onBookTable }) => {
            const [selectedTable, setSelectedTable] = useState(null);
            return (
                <div className="p-6 md:p-10 max-w-6xl mx-auto">
                    <h1 className="text-3xl font-black text-white mb-8">CH√ÄO M·ª™NG QU√ù KH√ÅCH</h1>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {tables.map(table => (
                            <div key={table.id} onClick={() => table.status === 'empty' ? setSelectedTable(table) : null} className={`aspect-square rounded-2xl p-4 flex flex-col justify-between border-2 ${table.status === 'empty' ? 'bg-slate-800 border-slate-600 hover:border-amber-500 cursor-pointer' : 'bg-slate-900 border-slate-800 opacity-50'}`}>
                                <div className="flex justify-between"><span className="text-xs font-bold bg-slate-700 px-2 rounded text-slate-300">{table.zone}</span></div>
                                <div className="text-center"><h3 className="text-xl font-black text-white">{table.name}</h3><p className="text-xs text-slate-500">{table.status}</p></div>
                            </div>
                        ))}
                    </div>
                    {selectedTable && <Modal title="ƒê·∫∑t b√†n" onClose={()=>setSelectedTable(null)}><button onClick={()=>{onBookTable(selectedTable.id, {time:'20:00'}); setSelectedTable(null); alert("ƒê√£ g·ª≠i y√™u c·∫ßu ƒë·∫∑t b√†n!")}} className="w-full bg-amber-600 p-3 rounded font-bold text-white">X√°c nh·∫≠n ƒë·∫∑t b√†n</button></Modal>}
                </div>
            );
        };

        // --- ADMIN: FINANCE DASHBOARD (ENHANCED) ---
        const FinanceDashboard = ({ transactions, expenses, paymentRequests, onApprovePayment, onAddExpense, tables, staffList, onAssignStaff }) => {
            const [view, setView] = useState('cashflow'); // cashflow, payments, history
            const [selectedRequest, setSelectedRequest] = useState(null); // For Invoice Popup
            const [newExpense, setNewExpense] = useState({ name: '', amount: '', type: 'Nh·∫≠p h√†ng' });

            const totalRevenue = transactions.reduce((s, t) => s + t.total, 0);
            const totalExpense = expenses.reduce((s, e) => s + e.amount, 0);
            const netProfit = totalRevenue - totalExpense;

            // Invoice Modal Renderer
            const renderInvoiceModal = () => {
                if (!selectedRequest) return null;
                const req = selectedRequest;
                const subTotal = req.total / 1.08;
                const vat = req.total - subTotal;

                return (
                    <Modal title="XU·∫§T H√ìA ƒê∆†N & THANH TO√ÅN" onClose={() => setSelectedRequest(null)}>
                        <div className="bg-white text-slate-900 p-6 rounded-lg font-mono text-sm shadow-xl border border-slate-300">
                            <div className="text-center pb-4 border-b border-dashed border-slate-400 mb-4">
                                <h2 className="text-2xl font-bold uppercase tracking-widest">TITAN CLUB</h2>
                                <p className="text-xs text-slate-500">123 Street, Night City</p>
                                <p className="text-xs text-slate-500 mt-1">H√ìA ƒê∆†N GTGT</p>
                                <p className="text-xs text-slate-500">{formatDate(new Date())}</p>
                            </div>
                            <div className="mb-4">
                                <p><strong>B√†n:</strong> {req.tableName}</p>
                                <p><strong>Nh√¢n vi√™n:</strong> {req.staff}</p>
                                <p><strong>Kh√°ch:</strong> Walk-in Guest</p>
                            </div>
                            <table className="w-full mb-4">
                                <thead>
                                    <tr className="border-b border-slate-300 text-left"><th className="pb-1">M√≥n</th><th className="pb-1 text-right">SL</th><th className="pb-1 text-right">Th√†nh ti·ªÅn</th></tr>
                                </thead>
                                <tbody>
                                    {req.items.map((item, i) => (
                                        <tr key={i}><td className="py-1">{item.name}</td><td className="text-right">{item.qty}</td><td className="text-right">{formatMoney(item.price * item.qty)}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                            <div className="border-t border-slate-400 pt-2 space-y-1 text-right">
                                <div className="flex justify-between"><span>T·∫°m t√≠nh:</span><span>{formatMoney(subTotal)}</span></div>
                                <div className="flex justify-between"><span>VAT (8%):</span><span>{formatMoney(vat)}</span></div>
                                <div className="flex justify-between text-xl font-bold mt-2 pt-2 border-t border-dashed border-slate-300"><span>T·ªîNG C·ªòNG:</span><span>{formatMoney(req.total)}</span></div>
                            </div>
                            
                            {/* QR CODE DEMO */}
                            <div className="mt-6 text-center">
                                <p className="text-xs font-bold mb-2">QU√âT M√É ƒê·ªÇ THANH TO√ÅN</p>
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=TITANCLUB-${req.total}`} className="mx-auto border-2 border-slate-900 p-2 rounded" alt="QR Code" />
                                <p className="text-[10px] text-slate-500 mt-1">H·ªó tr·ª£ m·ªçi ng√¢n h√†ng / V√≠ ƒëi·ªán t·ª≠</p>
                            </div>
                        </div>
                        <div className="mt-6 flex gap-3">
                            <button onClick={() => setSelectedRequest(null)} className="flex-1 py-3 bg-slate-700 rounded-lg font-bold hover:bg-slate-600 text-white">ƒê√≥ng</button>
                            <button onClick={() => { onApprovePayment(req); setSelectedRequest(null); }} className="flex-1 py-3 bg-green-600 rounded-lg font-bold text-white hover:bg-green-500 flex items-center justify-center gap-2">
                                <Icon name="check-circle"/> X√°c nh·∫≠n ƒê√£ Thu Ti·ªÅn
                            </button>
                        </div>
                    </Modal>
                );
            };

            return (
                <div className="p-6 md:p-10 h-full overflow-y-auto">
                    {renderInvoiceModal()}
                    
                    <div className="flex gap-4 mb-8 border-b border-slate-800 pb-4 overflow-x-auto">
                        <button onClick={() => setView('cashflow')} className={`px-4 py-2 rounded-lg font-bold flex gap-2 ${view === 'cashflow' ? 'bg-amber-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}><Icon name="pie-chart"/> T√†i Ch√≠nh & D√≤ng Ti·ªÅn</button>
                        <button onClick={() => setView('payments')} className={`px-4 py-2 rounded-lg font-bold flex gap-2 relative ${view === 'payments' ? 'bg-green-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}>
                            <Icon name="credit-card"/> Thu Ng√¢n 
                            {paymentRequests.length > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center animate-bounce">{paymentRequests.length}</span>}
                        </button>
                        <button onClick={() => setView('history')} className={`px-4 py-2 rounded-lg font-bold flex gap-2 ${view === 'history' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}><Icon name="list"/> S·ªï Qu·ªπ & Giao D·ªãch</button>
                    </div>

                    {view === 'cashflow' && (
                        <div className="space-y-6 animate-fade-in">
                            {/* Financial Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="bg-slate-800 p-6 rounded-xl border-l-4 border-green-500 shadow-lg">
                                    <p className="text-slate-400 text-sm">Doanh Thu (Revenue)</p>
                                    <p className="text-3xl font-black text-green-400 mt-2">{formatMoney(totalRevenue)}</p>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-xl border-l-4 border-red-500 shadow-lg">
                                    <p className="text-slate-400 text-sm">Chi Ph√≠ (Expenses)</p>
                                    <p className="text-3xl font-black text-red-400 mt-2">{formatMoney(totalExpense)}</p>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-xl border-l-4 border-amber-500 shadow-lg">
                                    <p className="text-slate-400 text-sm">L·ª£i Nhu·∫≠n R√≤ng</p>
                                    <p className={`text-3xl font-black mt-2 ${netProfit >= 0 ? 'text-amber-400' : 'text-red-500'}`}>{formatMoney(netProfit)}</p>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-xl border-l-4 border-blue-500 shadow-lg flex items-center justify-between">
                                    <div>
                                        <p className="text-slate-400 text-sm">S·ªë Giao D·ªãch</p>
                                        <p className="text-3xl font-black text-blue-400 mt-2">{transactions.length}</p>
                                    </div>
                                    <Icon name="activity" size={40} className="text-blue-500 opacity-50"/>
                                </div>
                            </div>

                            {/* Expense Entry */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700">
                                    <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icon name="minus-circle" className="text-red-500"/> Qu·∫£n L√Ω Chi Ph√≠</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <input placeholder="T√™n kho·∫£n chi..." className="bg-slate-900 border border-slate-600 rounded p-3 text-white" value={newExpense.name} onChange={e=>setNewExpense({...newExpense, name: e.target.value})} />
                                        <input type="number" placeholder="S·ªë ti·ªÅn..." className="bg-slate-900 border border-slate-600 rounded p-3 text-white" value={newExpense.amount} onChange={e=>setNewExpense({...newExpense, amount: e.target.value})} />
                                        <select className="bg-slate-900 border border-slate-600 rounded p-3 text-white" value={newExpense.type} onChange={e=>setNewExpense({...newExpense, type: e.target.value})}>
                                            <option>Nh·∫≠p h√†ng</option><option>ƒêi·ªán n∆∞·ªõc</option><option>L∆∞∆°ng th∆∞·ªüng</option><option>Marketing</option><option>Kh√°c</option>
                                        </select>
                                    </div>
                                    <button onClick={() => { onAddExpense({...newExpense, amount: Number(newExpense.amount), id: Date.now(), date: new Date().toISOString()}); setNewExpense({name:'', amount:'', type:'Nh·∫≠p h√†ng'}); }} className="bg-red-600 hover:bg-red-500 text-white font-bold px-6 py-3 rounded-lg w-full md:w-auto">L∆∞u Kho·∫£n Chi</button>
                                </div>
                                <div className="bg-slate-800 p-6 rounded-xl border border-slate-700">
                                    <h3 className="font-bold text-white mb-4">Ph√¢n T√≠ch Nhanh</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <div className="flex justify-between text-xs text-slate-400 mb-1"><span>L·ª£i nhu·∫≠n bi√™n</span><span>{totalRevenue > 0 ? ((netProfit/totalRevenue)*100).toFixed(1) : 0}%</span></div>
                                            <div className="h-2 bg-slate-700 rounded-full"><div className="h-full bg-blue-500 rounded-full" style={{width: `${totalRevenue > 0 ? (netProfit/totalRevenue)*100 : 0}%`}}></div></div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Chi ph√≠ / Doanh thu</span><span>{totalRevenue > 0 ? ((totalExpense/totalRevenue)*100).toFixed(1) : 0}%</span></div>
                                            <div className="h-2 bg-slate-700 rounded-full"><div className="h-full bg-red-500 rounded-full" style={{width: `${totalRevenue > 0 ? (totalExpense/totalRevenue)*100 : 0}%`}}></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'payments' && (
                        <div className="animate-fade-in">
                            <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                <Icon name="bell-ring" className="text-amber-500 animate-pulse-slow"/> Y√™u C·∫ßu Thanh To√°n T·ª´ Staff ({paymentRequests.length})
                            </h3>
                            {paymentRequests.length === 0 ? (
                                <div className="text-center p-10 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">
                                    <Icon name="check-circle" size={48} className="text-green-500 mx-auto mb-4"/>
                                    <p className="text-slate-400">Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù.</p>
                                </div>
                            ) : (
                                <div className="grid gap-4">
                                    {paymentRequests.map(req => (
                                        <div key={req.id} className="bg-slate-800 p-6 rounded-xl border border-slate-600 flex flex-col md:flex-row justify-between items-center shadow-lg hover:border-amber-500 transition-colors">
                                            <div className="mb-4 md:mb-0">
                                                <div className="flex items-center gap-3">
                                                    <h4 className="font-black text-2xl text-white">{req.tableName}</h4>
                                                    <span className="bg-purple-900 text-purple-200 text-xs px-2 py-1 rounded font-bold">Ch·ªù thanh to√°n</span>
                                                </div>
                                                <p className="text-amber-500 font-mono text-xl font-bold mt-1">{formatMoney(req.total)}</p>
                                                <p className="text-slate-500 text-sm mt-1">Staff: {req.staff} ‚Ä¢ {formatDate(req.time)}</p>
                                            </div>
                                            <button onClick={() => setSelectedRequest(req)} className="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-green-500/20 flex items-center gap-2">
                                                <Icon name="printer"/> Xu·∫•t H√≥a ƒê∆°n
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {view === 'history' && (
                        <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden animate-fade-in">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-900 text-slate-400 uppercase">
                                    <tr>
                                        <th className="p-4">Th·ªùi gian</th>
                                        <th className="p-4">Lo·∫°i</th>
                                        <th className="p-4">N·ªôi dung</th>
                                        <th className="p-4 text-right">S·ªë ti·ªÅn</th>
                                        <th className="p-4">Ng∆∞·ªùi th·ª±c hi·ªán</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {transactions.map(t => (
                                        <tr key={t.id} className="hover:bg-slate-700/50">
                                            <td className="p-4 text-slate-400">{formatDate(t.time)}</td>
                                            <td className="p-4"><span className="bg-green-500/10 text-green-400 px-2 py-1 rounded text-xs">Thu (In)</span></td>
                                            <td className="p-4 text-white font-medium">{t.table}</td>
                                            <td className="p-4 text-right font-bold text-green-400">+{formatMoney(t.total)}</td>
                                            <td className="p-4 text-slate-400">{t.staff}</td>
                                        </tr>
                                    ))}
                                    {expenses.map(e => (
                                        <tr key={e.id} className="hover:bg-slate-700/50">
                                            <td className="p-4 text-slate-400">{formatDate(e.date)}</td>
                                            <td className="p-4"><span className="bg-red-500/10 text-red-400 px-2 py-1 rounded text-xs">Chi (Out)</span></td>
                                            <td className="p-4 text-white font-medium">{e.name} <span className="text-xs text-slate-500">({e.type})</span></td>
                                            <td className="p-4 text-right font-bold text-red-400">-{formatMoney(e.amount)}</td>
                                            <td className="p-4 text-slate-400">Admin</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // --- POS SYSTEM ---
        const POSSystem = ({ tables, menu, currentUser, onUpdateTable, onRequestPayment, onVoidRequest }) => {
            const [activeTable, setActiveTable] = useState(null);
            const [voidItem, setVoidItem] = useState(null);

            const calculateTotal = (orders) => orders.reduce((sum, item) => sum + (item.price * item.qty), 0);

            const handleTableClick = (table) => {
                if(table.status === 'payment_requested') return alert("B√†n n√†y ƒëang ch·ªù Admin thanh to√°n. Kh√¥ng th·ªÉ ch·ªânh s·ª≠a.");
                if (currentUser.role === 'manager' || table.status === 'empty' || table.owner === currentUser.username) {
                    setActiveTable(table);
                } else {
                    alert(`‚õî B√†n n√†y c·ªßa ${table.owner || 'ng∆∞·ªùi kh√°c'}.`);
                }
            };

            const addToOrder = (item) => {
                const currentOrders = activeTable.orders ? [...activeTable.orders] : [];
                const existingIndex = currentOrders.findIndex(o => o.id === item.id);
                if (existingIndex > -1) {
                    currentOrders[existingIndex] = { ...currentOrders[existingIndex], qty: currentOrders[existingIndex].qty + 1 };
                } else {
                    currentOrders.push({ ...item, qty: 1, committedQty: 0 });
                }
                setActiveTable({ ...activeTable, orders: currentOrders });
            };

            const handleMinusClick = (item) => {
                if (item.qty > (item.committedQty || 0)) {
                     const currentOrders = [...activeTable.orders];
                     const idx = currentOrders.findIndex(o => o.id === item.id);
                     if (currentOrders[idx].qty > 1) currentOrders[idx].qty -= 1;
                     else currentOrders.splice(idx, 1);
                     setActiveTable({ ...activeTable, orders: currentOrders });
                } else {
                    setVoidItem(item);
                }
            };

            const saveOrder = () => {
                const committedOrders = activeTable.orders.map(o => ({ ...o, committedQty: o.qty }));
                onUpdateTable(activeTable.id, { 
                    orders: committedOrders, 
                    status: 'occupied', 
                    owner: (activeTable.status === 'empty' || !activeTable.owner) ? currentUser.username : activeTable.owner
                });
                setActiveTable(null);
            };

            // NEW: Request Payment Workflow
            const handlePaymentRequest = () => {
                if(activeTable.orders.length === 0) return;
                const total = calculateTotal(activeTable.orders) * 1.08;
                onRequestPayment({
                    id: Date.now(),
                    tableId: activeTable.id,
                    tableName: activeTable.name,
                    items: activeTable.orders,
                    total: total,
                    time: new Date().toISOString(),
                    staff: currentUser.username
                });
                setActiveTable(null);
                alert("ƒê√£ g·ª≠i y√™u c·∫ßu thanh to√°n ƒë·∫øn Admin!");
            };

            if (activeTable) return (
                <div className="fixed inset-0 bg-slate-900 z-40 flex flex-col md:flex-row animate-fade-in">
                    <div className="md:hidden h-14 border-b border-slate-700 flex items-center justify-between px-4 bg-slate-800">
                        <button onClick={() => setActiveTable(null)}><Icon name="arrow-left"/></button>
                        <span className="font-bold">{activeTable.name}</span>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:border-r border-slate-700 bg-slate-900">
                         <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                            {menu.map(item => (
                                <button key={item.id} onClick={() => addToOrder(item)} className="bg-slate-800 p-3 rounded-xl border border-slate-700 active:scale-95 transition-transform text-left hover:border-amber-500">
                                    <div className="text-3xl mb-2">{item.image}</div>
                                    <div className="font-bold text-sm text-slate-200 truncate">{item.name}</div>
                                    <div className="text-amber-500 text-xs font-mono">{formatMoney(item.price)}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="h-[45vh] md:h-full md:w-96 bg-slate-800 flex flex-col border-t md:border-t-0 border-slate-700 shadow-2xl">
                         <div className="hidden md:flex p-4 border-b border-slate-700 justify-between items-center">
                            <h2 className="font-bold text-xl">{activeTable.name}</h2>
                            <button onClick={() => setActiveTable(null)}><Icon name="x" className="text-slate-400 hover:text-white"/></button>
                        </div>
                         <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {activeTable.orders.map((item, idx) => (
                                <div key={idx} className="flex justify-between items-center bg-slate-700/30 p-2 rounded">
                                    <div className="flex-1"><div className="text-sm font-bold text-white">{item.name}</div><div className="text-xs text-amber-500">{formatMoney(item.price)}</div></div>
                                    <div className="flex items-center gap-3 bg-slate-900 rounded p-1">
                                        <button onClick={() => handleMinusClick(item)} className="p-1 text-slate-400 hover:text-red-400"><Icon name="minus" size={16}/></button>
                                        <span className="font-mono font-bold text-white w-4 text-center">{item.qty}</span>
                                        <button onClick={() => addToOrder(item)} className="p-1 text-slate-400 hover:text-green-400"><Icon name="plus" size={16}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                         <div className="p-4 bg-slate-900 border-t border-slate-700 space-y-3">
                             <div className="flex justify-between text-white text-lg font-bold"><span>Total (VAT 8%)</span><span className="text-amber-500">{formatMoney(calculateTotal(activeTable.orders) * 1.08)}</span></div>
                             <div className="grid grid-cols-2 gap-2">
                                <button onClick={saveOrder} className="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold">G·ª≠i B·∫øp</button>
                                <button onClick={handlePaymentRequest} className="bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2"><Icon name="bell-ring" size={18}/> Y√™u c·∫ßu TT</button>
                            </div>
                        </div>
                    </div>
                    {voidItem && <Modal title="H·ªßy m√≥n" onClose={()=>setVoidItem(null)}><button onClick={()=>{onVoidRequest(activeTable.id, activeTable.name, voidItem, 1); setVoidItem(null); alert("ƒê√£ g·ª≠i y√™u c·∫ßu h·ªßy!");}} className="w-full bg-red-600 p-3 rounded font-bold text-white">X√°c nh·∫≠n H·ªßy</button></Modal>}
                </div>
            );

            return (
                <div className="h-full flex flex-col">
                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {tables.map(table => {
                             const isMyTable = table.owner === currentUser.username;
                             const isPending = table.status === 'payment_requested';
                             const isOccupied = table.status === 'occupied';
                             return (
                                <div key={table.id} onClick={() => handleTableClick(table)} className={`relative aspect-square rounded-2xl p-4 flex flex-col justify-between cursor-pointer border-2 transition-all active:scale-95 ${isPending ? 'bg-purple-900/50 border-purple-500 animate-pulse' : isOccupied ? (isMyTable ? 'bg-slate-800 border-green-500' : 'bg-slate-800 border-red-900 opacity-70') : 'bg-slate-800 border-slate-700 hover:border-slate-500'}`}>
                                    <div className="flex justify-between items-center">
                                        <span className="text-[10px] font-black px-2 py-0.5 rounded uppercase bg-slate-700 text-slate-400">{table.zone}</span>
                                        {isPending && <Icon name="clock" size={14} className="text-purple-400"/>}
                                    </div>
                                    <div className="text-center">
                                        <h3 className="text-xl font-black text-white">{table.name}</h3>
                                        {isPending ? <p className="text-purple-400 text-xs mt-1 font-bold">Ch·ªù thanh to√°n</p> : isOccupied ? <p className="text-green-400 text-xs font-mono mt-1">{formatMoney(calculateTotal(table.orders))}</p> : <p className="text-slate-600 text-xs mt-1">Tr·ªëng</p>}
                                    </div>
                                </div>
                             )
                        })}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null); 
            const [view, setView] = useState('dashboard');
            
            // CORE DATA
            const [menu, setMenu] = useState(SEED_MENU);
            const [tables, setTables] = useState(SEED_TABLES);
            const [transactions, setTransactions] = useState([]); // Completed transactions
            const [paymentRequests, setPaymentRequests] = useState([]); // Pending payments
            const [expenses, setExpenses] = useState(SEED_EXPENSES);
            const [feedbacks, setFeedbacks] = useState(SEED_FEEDBACKS);

            const handleLogin = (user) => {
                setCurrentUser(user);
                if (user.role === 'staff') setView('pos');
                else if (user.role === 'guest') setView('guest-dashboard');
                else setView('dashboard');
            };

            const handleUpdateTable = (tableId, newData) => {
                setTables(prev => prev.map(t => t.id === tableId ? { ...t, ...newData } : t));
            };

            // NEW: Step 1 - Staff requests payment
            const handleRequestPayment = (request) => {
                setPaymentRequests([...paymentRequests, request]);
                handleUpdateTable(request.tableId, { status: 'payment_requested' });
            };

            // NEW: Step 2 - Admin approves payment
            const handleApprovePayment = (request) => {
                // Add to transactions
                setTransactions([{ 
                    id: Date.now(), 
                    total: request.total, 
                    time: new Date().toISOString(), 
                    table: request.tableName,
                    staff: request.staff 
                }, ...transactions]);
                
                // Remove from requests
                setPaymentRequests(paymentRequests.filter(r => r.id !== request.id));
                
                // Clear table
                handleUpdateTable(request.tableId, { orders: [], status: 'empty', owner: null, booking: null });
                
                alert("ƒê√£ thu ti·ªÅn v√† ƒë√≥ng b√†n th√†nh c√¥ng!");
            };

            const handleBookTable = (tableId, bookingInfo) => {
                setTables(prev => prev.map(t => t.id === tableId ? { ...t, status: 'reserved', booking: bookingInfo } : t));
            };

            // MOCK VOID LOGIC
            const handleVoidRequest = (tid, tname, item, qty) => alert("Mock: ƒê√£ g·ª≠i y√™u c·∫ßu h·ªßy.");

            if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200">
                    <div className="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center sticky top-0 z-30">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center text-xl font-bold text-black">T</div>
                            <div>
                                <h1 className="font-bold text-white">TITAN CLUB</h1>
                                <p className="text-xs text-slate-400">{currentUser.name} ({currentUser.role})</p>
                            </div>
                        </div>
                        <button onClick={() => setCurrentUser(null)} className="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg text-sm font-bold border border-slate-600">ƒêƒÉng Xu·∫•t</button>
                    </div>

                    <div className="h-[calc(100vh-80px)] overflow-hidden">
                        {currentUser.role === 'guest' && (
                            <GuestDashboard tables={tables} menu={menu} onBookTable={handleBookTable} />
                        )}
                        {currentUser.role === 'manager' && (
                            <FinanceDashboard 
                                transactions={transactions} 
                                expenses={expenses} 
                                paymentRequests={paymentRequests}
                                onApprovePayment={handleApprovePayment}
                                onAddExpense={(exp) => setExpenses([exp, ...expenses])} 
                                feedbacks={feedbacks}
                                tables={tables}
                                staffList={USERS.filter(u=>u.role==='staff')}
                                onAssignStaff={(tid, sid) => handleUpdateTable(tid, {owner: sid})}
                            />
                        )}
                        {currentUser.role === 'staff' && (
                            <POSSystem 
                                tables={tables} 
                                menu={menu} 
                                currentUser={currentUser} 
                                onUpdateTable={handleUpdateTable} 
                                onRequestPayment={handleRequestPayment}
                                onVoidRequest={handleVoidRequest} 
                            />
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
